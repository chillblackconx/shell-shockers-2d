<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Shell Shokers 2D - Team Mode</title>
<style>
html,body { height:100%; margin:0; background:#0b1020; }
#gameDiv { width:100%; height:100vh; display:flex; align-items:center; justify-content:center; position:relative; }

.ui { position: absolute; top:8px; left:8px; color:#fff; font-family: system-ui, Arial; z-index:10; display:none; }
.ui button{ margin-left:8px }
#hpBar { width:150px; height:16px; border:1px solid #fff; margin-top:6px; }
#hpFill { height:100%; background:#4caf50; width:100%; }

/* login / menu / death */
#login, #menu, #deathScreen {
position: absolute; top:0; left:0; right:0; bottom:0;
background: rgba(0,0,0,0.8); color:white;
display:flex; flex-direction:column; justify-content:center; align-items:center;
font-family: Arial, sans-serif;
}
#login input, #menu input { padding:8px; font-size:16px; margin:10px; }
#login button, #menu button, #deathScreen button { padding:10px 20px; font-size:18px; margin-top:15px; }
</style>
</head>
<body>
<div id="gameDiv"></div>

<div id="login">
<h1>Connexion</h1>
<p>Entre ton nom d'utilisateur :</p>
<input id="username" type="text" placeholder="Pseudo">
<button onclick="startLogin()">Valider</button>
</div>

<div id="menu" style="display:none;">
<h1>Menu Principal</h1>
<label><input type="checkbox" id="invincible"> Mode invincible</label><br><br>
<button onclick="startGame()">Commencer la partie</button>
</div>

<div class="ui" id="hud">
<span id="score">Score Rouge: 0 | Score Bleu: 0</span>
<span id="playerName"></span>
<button id="restart">Restart</button>
<button id="pause">Pause</button>
<div id="hpBar"><div id="hpFill"></div></div>
</div>

<div id="deathScreen" style="display:none;">
<h1>Tu es mort ðŸ˜µ</h1>
<p id="finalScore"></p>
<button onclick="backToMenu()">Retour au menu</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
<script>
const WIDTH = 1280, HEIGHT = 720, MAP_SIZE = 2000;
let player, cursors, bullets, enemies, lastFired=0;
let hp=100, hpMax=100, isPaused=false;
let username="", invincible=false;

// Team scores
let scoreRed=0, scoreBlue=0;

const config = {
type: Phaser.AUTO,
width: WIDTH,
height: HEIGHT,
parent:'gameDiv',
backgroundColor:'#0b1020',
physics:{ default:'arcade', arcade:{ debug:false } },
scene:{ preload, create, update }
};
const game = new Phaser.Game(config);

function startLogin(){
const val=document.getElementById("username").value.trim();
if(val===""){ alert("Entre un pseudo !"); return; }
username = val;
document.getElementById("login").style.display="none";
document.getElementById("menu").style.display="flex";
}

function startGame(){
invincible = document.getElementById("invincible").checked;
document.getElementById("menu").style.display="none";
document.getElementById("hud").style.display="block";
document.getElementById("playerName").innerText=" | Joueur: "+username;
restart(game.scene.scenes[0]);
}

function backToMenu(){
document.getElementById("deathScreen").style.display="none";
document.getElementById("menu").style.display="flex";
hp=hpMax;
scoreRed=0; scoreBlue=0;
updateTeamScore();
}

// Phaser
function preload(){}
function create(){
const g=this.add.graphics(); g.fillStyle(0x1a1f3a,1); g.fillRect(0,0,MAP_SIZE,MAP_SIZE);

const g2=this.make.graphics({x:0,y:0,add:false});
g2.clear(); g2.fillStyle(0xffffdd,1); g2.fillEllipse(32,24,50,60); // bigger player
g2.lineStyle(4,0x333333,1); g2.strokeEllipse(32,24,50,60);
g2.generateTexture('egg',64,64);

g2.clear(); g2.fillStyle(0xffee66,1); g2.fillRect(0,0,8,16); g2.generateTexture('bullet',8,16);

g2.clear(); g2.fillStyle(0xff9999,1); g2.fillEllipse(20,20,36,40); // bigger bots
g2.lineStyle(2,0x770000,1); g2.strokeTriangle(8,10,28,10,18,28);
g2.generateTexture('enemy',40,40);

// Player
player = this.physics.add.sprite(MAP_SIZE/2, MAP_SIZE/2,'egg');
player.setCollideWorldBounds(true); player.setDrag(600,600); player.setMaxVelocity(300);
player.team = Math.random()<0.5?'red':'blue';

this.cameras.main.setBounds(0,0,MAP_SIZE,MAP_SIZE);
this.physics.world.setBounds(0,0,MAP_SIZE,MAP_SIZE);
this.cameras.main.startFollow(player);

bullets = this.physics.add.group({classType:Phaser.Physics.Arcade.Image, runChildUpdate:true});
enemies = this.physics.add.group();

cursors = this.input.keyboard.createCursorKeys();
this.input.keyboard.addKeys('W,A,S,D');

// shooting
this.input.on('pointerdown', pointer => shoot(pointer,this));
this.input.keyboard.on('keydown-SPACE', ()=>{ 
shoot({worldX:player.x + Math.cos(player.rotation-Math.PI/2)*1000, 
       worldY:player.y + Math.sin(player.rotation-Math.PI/2)*1000}, this);
});

// spawn bots
this.time.addEvent({delay:1500, callback:spawnEnemy, callbackScope:this, loop:true});

this.physics.add.overlap(bullets,enemies,onBulletHitEnemy,null,this);
this.physics.add.overlap(player,enemies,onPlayerHit,null,this);

document.getElementById('restart').onclick = ()=>restart(this);
document.getElementById('pause').onclick = ()=>togglePause(this);

updateScore(0); updateHP(0); updateTeamScore();
}

function update(time){
if(isPaused) return;

// player rotation
const pointer = this.input.activePointer;
const angle = Phaser.Math.Angle.Between(player.x,player.y,pointer.worldX,pointer.worldY);
player.setRotation(angle+Math.PI/2);

// movement
const keys=this.input.keyboard.addKeys('W,A,S,D');
let vx=0,vy=0;
if(keys.A.isDown||cursors.left.isDown) vx-=220;
if(keys.D.isDown||cursors.right.isDown) vx+=220;
if(keys.W.isDown||cursors.up.isDown) vy-=220;
if(keys.S.isDown||cursors.down.isDown) vy+=220;
player.setVelocity(vx,vy);

// bots AI
enemies.children.iterate(e=>{
if(e){ 
  // move to nearest enemy
  let target = (player.team!==e.team)?player:null;
  enemies.children.iterate(o=>{if(o!==e && o.team!==e.team) target=o;});
  if(target) this.physics.moveToObject(e,target,80); 
  
  // aim and shoot
  if(!isPaused && this.time.now - e.lastFired > 1500){
    e.lastFired = this.time.now;
    shoot({worldX:target.x, worldY:target.y}, this, e);
  }

  if(e.text) e.update();
}});

// bullets cleanup
bullets.children.iterate(b=>{if(b && (b.x<-50||b.x>MAP_SIZE+50||b.y<-50||b.y>MAP_SIZE+50)) b.destroy();});
}

function shoot(pointer,scene,shooter){
if(isPaused) return;
const now = scene.time.now;
if(shooter){
  if(!shooter.lastFired) shooter.lastFired=0;
  if(now-shooter.lastFired<500) return;
  shooter.lastFired=now;
  var sx=shooter.x, sy=shooter.y;
} else {
  if(now-lastFired<200) return;
  lastFired=now;
  var sx=player.x, sy=player.y;
}

const bullet = bullets.create(sx,sy,'bullet');
const angle = Phaser.Math.Angle.Between(sx,sy,pointer.worldX,pointer.worldY);
scene.physics.velocityFromRotation(angle,600,bullet.body.velocity);
bullet.setRotation(angle+Math.PI/2);
bullet.team = shooter?shooter.team:player.team;
}

function spawnEnemy(){
const side = Phaser.Math.Between(0,3); let x,y;
if(side===0){x=-30;y=Phaser.Math.Between(0,MAP_SIZE);}
else if(side===1){x=MAP_SIZE+30;y=Phaser.Math.Between(0,MAP_SIZE);}
else if(side===2){x=Phaser.Math.Between(0,MAP_SIZE);y=-30;}
else{x=Phaser.Math.Between(0,MAP_SIZE);y=MAP_SIZE+30;}

const e=enemies.create(x,y,'enemy'); e.setCircle(18); e.hp=20;
e.team = Math.random()<0.5?'red':'blue';
e.name = "Bot"; 
e.text = e.scene.add.text(e.x,e.y-30,e.name,{font:"16px Arial",fill:e.team}).setOrigin(0.5);
e.update = function(){ this.text.setPosition(this.x,this.y-30);}
e.lastFired = 0;
}

function onBulletHitEnemy(bullet,enemy){
if(bullet.team===enemy.team) return;
bullet.destroy(); enemy.hp-=10;
if(enemy.hp<=0){ 
  if(enemy.text) enemy.text.destroy(); 
  enemy.destroy(); 
  if(enemy.team==='red') scoreBlue+=10; else scoreRed+=10;
  updateTeamScore();
}
}

function onPlayerHit(playerObj,enemy){
if(enemy.team===playerObj.team) return;
enemy.destroy(); if(enemy.text) enemy.text.destroy();
if(!invincible) updateHP(-20); 
playerObj.scene.cameras.main.flash(200,255,80,80);
if(enemy.team==='red') scoreBlue+=5; else scoreRed+=5;
updateTeamScore();
}

function updateScore(delta){}
function updateTeamScore(){
document.getElementById('score').innerText='Score Rouge: '+scoreRed+' | Score Bleu: '+scoreBlue;
}

function updateHP(delta){
hp=Math.max(0,Math.min(hpMax,hp+delta));
document.getElementById('hpFill').style.width=(hp/hpMax*100)+'%';
if(hp<=0){
isPaused=true;
document.getElementById("hud").style.display="none";
document.getElementById("deathScreen").style.display="flex";
document.getElementById("finalScore").innerText="Ton score: "+scoreRed+" | "+scoreBlue;
}
}

function restart(scene){
enemies.clear(true,true);
bullets.clear(true,true);
player.x=MAP_SIZE/2; player.y=MAP_SIZE/2;
hp=hpMax; scoreRed=0; scoreBlue=0;
updateTeamScore(); isPaused=false;
}

function togglePause(scene){
isPaused=!isPaused;
document.getElementById('pause').innerText=isPaused?'Resume':'Pause';
scene.physics.world.isPaused=isPaused;
scene.time.paused=isPaused;
}

window.addEventListener('resize',()=>{game.scale.resize(Math.min(window.innerWidth,1280),Math.min(window.innerHeight,720));});
</script>
</body>
</html>
